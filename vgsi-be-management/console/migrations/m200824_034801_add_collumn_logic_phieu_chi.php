<?php

use yii\db\Migration;

/**
 * Class m200824_034801_add_collumn_logic_phieu_chi
 */
class m200824_034801_add_collumn_logic_phieu_chi extends Migration
{
    /**
     * {@inheritdoc}
     */
    public function safeUp()
    {
        //Thêm template
        $this->addColumn('building_cluster', 'service_bill_invoice_template', $this->getDb()->getSchema()->createColumnSchemaBuilder('longtext')->comment('Mẫu phiếu chi'));
        //Thêm kiểu phiếu chi
        $this->addColumn('service_bill_number', 'type', $this->integer(11)->defaultValue(0)->comment('0 - Phiếu thu, 1 - Phiếu chi'));
        $this->addColumn('service_bill', 'type', $this->integer(11)->defaultValue(0)->comment('0 - Phiếu thu, 1 - Phiếu chi'));
        $this->addColumn('service_bill', 'bank_name', $this->string(255)->comment('Tên tài khoản nhận tiền - Phiếu chi'));
        $this->addColumn('service_bill', 'bank_account', $this->string(255)->comment('Số tài khoản nhận tiền - Phiếu chi'));
        $this->addColumn('service_bill', 'bank_holders', $this->string(255)->comment('Chủ tài khoản nhận tiền - Phiếu chi'));
        //Thêm loại phí
        $this->addColumn('service_payment_fee', 'for_type', $this->integer(11)->defaultValue(0)->comment('0 - Phí sử dụng, 1- phí đặt cọc, 2 - phí phát sinh'));
        $this->addColumn('service_payment_fee', 'service_bill_invoice_id', $this->integer(11));
        //Cấu hình phí đặt cọc
        $this->addColumn('service_utility_free', 'deposit_money', $this->integer(11)->defaultValue(0)->comment('Số tiền phí cần đặt cọc khi book dịch vụ'));
        //Tạo liên kết phí booking
        $this->addColumn('service_utility_booking', 'total_deposit_money', $this->integer(11)->defaultValue(0)->comment('Tổng tiền đặt cọc khi book dịch vụ'));
        $this->addColumn('service_utility_booking', 'total_incurred_money', $this->integer(11)->defaultValue(0)->comment('Tổng tiền phát sinh khi sử dụng dịch vụ'));
        $this->addColumn('service_utility_booking', 'service_payment_fee_deposit_ids', $this->string(255)->comment('Các ids map với phí đặt cọc'));
        $this->addColumn('service_utility_booking', 'service_payment_fee_incurred_ids', $this->string(255)->comment('Các ids map với phí phát sinh'));

        //update mẫu phiếu chi còn thiếu
        $buildingClusters = \common\models\BuildingCluster::find()->where(['service_bill_invoice_template' => null])->all();
        foreach ($buildingClusters as $buildingCluster){
            $buildingCluster->service_bill_invoice_template = '{"style_string":"\n .jsx-parser ol {\n margin: 0;\n padding: 0\n }\n \n .jsx-parser table td,\n table th {\n padding: 0\n }\n \n .jsx-parser .c7c20{\n min-width: 30%;\n color: #000000;\n font-weight: 700;\n text-decoration: none;\n vertical-align: baseline;\n font-size: 10pt;\n font-family: \"Times New Roman\";\n font-style: normal;\n text-align: right;\n }\n .jsx-parser .c7 {\n border-right-style: solid;\n padding-top: 6pt;\n border-top-width: 0pt;\n border-bottom-color: null;\n border-right-width: 0pt;\n padding-left: 0pt;\n border-left-color: null;\n padding-bottom: 6pt;\n line-height: 1.0;\n border-right-color: null;\n border-left-width: 0pt;\n border-top-style: solid;\n background-color: #ffffff;\n border-left-style: solid;\n border-bottom-width: 0pt;\n border-top-color: null;\n border-bottom-style: solid;\n orphans: 2;\n widows: 2;\n padding-right: 0pt;\n display: flex;\n justify-content: space-between;\n align-items: center;\n }\n \n .jsx-parser .c9 {\n border-right-style: solid;\n padding-top: 6pt;\n border-top-width: 0pt;\n border-bottom-color: null;\n border-right-width: 0pt;\n padding-left: 0pt;\n border-left-color: null;\n padding-bottom: 2pt;\n line-height: 1.0;\n border-right-color: null;\n border-left-width: 0pt;\n border-top-style: solid;\n border-left-style: solid;\n border-bottom-width: 0pt;\n border-top-color: null;\n border-bottom-style: solid;\n orphans: 2;\n widows: 2;\n text-align: center;\n padding-right: 0pt\n }\n .jsx-parser .c9999 {\n border-right-style: solid;\n padding-top: 1pt;\n border-top-width: 0pt;\n border-bottom-color: null;\n border-right-width: 0pt;\n padding-left: 0pt;\n border-left-color: null;\n padding-bottom: 1pt;\n line-height: 1.0;\n border-right-color: null;\n border-left-width: 0pt;\n border-top-style: solid;\n border-left-style: solid;\n border-bottom-width: 0pt;\n border-top-color: null;\n border-bottom-style: solid;\n orphans: 2;\n widows: 2;\n text-align: center;\n padding-right: 0pt\n }\n \n .jsx-parser .c3 {\n border-right-style: solid;\n padding: 2pt 2pt 2pt 2pt;\n border-bottom-color: #dddddd;\n border-top-width: 0pt;\n border-right-width: 0pt;\n border-left-color: #dddddd;\n vertical-align: top;\n border-right-color: #dddddd;\n border-left-width: 0pt;\n border-top-style: solid;\n background-color: #ffffff;\n border-left-style: solid;\n border-bottom-width: 0pt;\n width: 114.8pt;\n border-top-color: #dddddd;\n border-bottom-style: solid\n }\n \n .jsx-parser .c26 {\n border-right-style: solid;\n padding: 2pt 2pt 2pt 2pt;\n border-bottom-color: #dddddd;\n border-top-width: 0pt;\n border-right-width: 0pt;\n border-left-color: #dddddd;\n vertical-align: top;\n border-right-color: #dddddd;\n border-left-width: 0pt;\n border-top-style: solid;\n background-color: #ffffff;\n border-left-style: solid;\n border-bottom-width: 0pt;\n width: 86.2pt;\n border-top-color: #dddddd;\n border-bottom-style: solid\n }\n \n .jsx-parser .c27 {\n border-right-style: solid;\n padding: 2pt 2pt 2pt 2pt;\n border-bottom-color: #dddddd;\n border-top-width: 0pt;\n border-right-width: 0pt;\n border-left-color: #dddddd;\n vertical-align: top;\n border-right-color: #dddddd;\n border-left-width: 0pt;\n border-top-style: solid;\n background-color: #ffffff;\n border-left-style: solid;\n border-bottom-width: 0pt;\n width: 91.5pt;\n border-top-color: #dddddd;\n border-bottom-style: solid\n }\n \n .jsx-parser .c15 {\n border-right-style: solid;\n padding: 2pt 2pt 2pt 2pt;\n border-bottom-color: #dddddd;\n border-top-width: 0pt;\n border-right-width: 0pt;\n border-left-color: #dddddd;\n vertical-align: top;\n border-right-color: #dddddd;\n border-left-width: 0pt;\n border-top-style: solid;\n background-color: #ffffff;\n border-left-style: solid;\n border-bottom-width: 0pt;\n width: 68.2pt;\n border-top-color: #dddddd;\n border-bottom-style: solid\n }\n \n .jsx-parser .c6 {\n border-right-style: solid;\n padding: 5pt 5pt 5pt 5pt;\n border-bottom-color: #666666;\n border-top-width: 1pt;\n border-right-width: 1pt;\n border-left-color: #666666;\n vertical-align: top;\n border-right-color: #666666;\n border-left-width: 1pt;\n border-top-style: solid;\n border-left-style: solid;\n border-bottom-width: 1pt;\n width: 330pt;\n border-top-color: #666666;\n border-bottom-style: solid\n }\n \n .jsx-parser .c29 {\n border-right-style: solid;\n padding: 5pt 5pt 5pt 5pt;\n border-bottom-color: #000000;\n border-top-width: 0pt;\n border-right-width: 0pt;\n border-left-color: #000000;\n vertical-align: top;\n border-right-color: #000000;\n border-left-width: 0pt;\n border-top-style: solid;\n border-left-style: solid;\n border-bottom-width: 0pt;\n width: 243pt;\n border-top-color: #000000;\n border-bottom-style: solid\n }\n \n .jsx-parser .c30 {\n border-right-style: solid;\n padding: 2pt 2pt 2pt 2pt;\n border-bottom-color: #dddddd;\n border-top-width: 0pt;\n border-right-width: 0pt;\n border-left-color: #dddddd;\n vertical-align: top;\n border-right-color: #dddddd;\n border-left-width: 0pt;\n border-top-style: solid;\n border-left-style: solid;\n border-bottom-width: 0pt;\n width: 99pt;\n border-top-color: #dddddd;\n border-bottom-style: solid\n }\n \n .jsx-parser .c19 {\n border-right-style: solid;\n padding: 5pt 5pt 5pt 5pt;\n border-bottom-color: #000000;\n border-top-width: 0pt;\n border-right-width: 0pt;\n border-left-color: #000000;\n vertical-align: top;\n border-right-color: #000000;\n border-left-width: 0pt;\n border-top-style: solid;\n border-left-style: solid;\n border-bottom-width: 0pt;\n width: 255pt;\n border-top-color: #000000;\n border-bottom-style: solid\n }\n \n .jsx-parser .c14 {\n border-right-style: solid;\n padding: 5pt 5pt 5pt 5pt;\n border-bottom-color: #666666;\n border-top-width: 1pt;\n border-right-width: 1pt;\n border-left-color: #666666;\n vertical-align: top;\n border-right-color: #666666;\n border-left-width: 1pt;\n border-top-style: solid;\n border-left-style: solid;\n border-bottom-width: 1pt;\n width: 150pt;\n border-top-color: #666666;\n border-bottom-style: solid\n }\n \n .jsx-parser .c1 {\n color: #000000;\n font-weight: 400;\n text-decoration: none;\n vertical-align: baseline;\n font-size: 10pt;\n font-family: \"Times New Roman\";\n font-style: normal\n }\n \n .jsx-parser .c25 {\n color: #000000;\n font-weight: 400;\n text-decoration: none;\n vertical-align: baseline;\n font-size: 9pt;\n font-family: \"Times New Roman\";\n font-style: normal\n }\n \n .jsx-parser .c20 {\n color: #000000;\n font-weight: 700;\n text-decoration: none;\n vertical-align: baseline;\n font-size: 10pt;\n font-family: \"Times New Roman\";\n font-style: normal\n }\n \n .jsx-parser .c2 {\n color: #000000;\n font-weight: 700;\n text-decoration: none;\n vertical-align: baseline;\n font-size: 10.5pt;\n font-family: \"Times New Roman\";\n font-style: normal\n }\n \n .jsx-parser .c16 {\n color: #000000;\n font-weight: 400;\n text-decoration: none;\n vertical-align: baseline;\n font-size: 10.5pt;\n font-family: \"Times New Roman\";\n font-style: italic\n }\n \n .jsx-parser .c22 {\n color: #000000;\n font-weight: 700;\n text-decoration: none;\n vertical-align: baseline;\n font-size: 9pt;\n font-family: \"Times New Roman\";\n font-style: normal\n }\n \n .jsx-parser .c10 {\n color: #000000;\n font-weight: 400;\n text-decoration: none;\n vertical-align: baseline;\n font-size: 11pt;\n font-family: \"Arial\";\n font-style: normal\n }\n \n .jsx-parser .c17 {\n padding-top: 0pt;\n padding-bottom: 0pt;\n line-height: 1.15;\n orphans: 2;\n widows: 2;\n text-align: left\n }\n \n .jsx-parser .c5 {\n padding-top: 0pt;\n padding-bottom: 0pt;\n line-height: 1.0;\n text-align: center\n }\n \n .jsx-parser .c0 {\n padding-top: 0pt;\n padding-bottom: 0pt;\n line-height: 1.0;\n text-align: left\n }\n \n .jsx-parser .c24 {\n width:100%;\n border-spacing: 0;\n border-collapse: collapse;\n }\n \n .jsx-parser .c18 {\n width:100%;\n border-spacing: 0;\n border-collapse: collapse;\n }\n \n .jsx-parser .c23 {\n width:100%;\n border-spacing: 0;\n border-collapse: collapse;\n }\n \n .jsx-parser .c13 {\n font-size: 16pt;\n font-family: \"Times New Roman\";\n font-weight: 700;\n }\n \n .jsx-parser .c8 {\n background-color: #ffffff;\n padding: 0pt 8pt 0pt 8pt\n }\n \n .jsx-parser .c11 {\n background-color: #ffffff;\n height: 11pt\n }\n \n .jsx-parser .c21 {\n height: 11pt\n }\n \n .jsx-parser .c4 {\n height: 24pt\n }\n \n .jsx-parser .c28 {\n background-color: #ffffff\n }\n \n .jsx-parser .c12 {\n height: 0pt\n }\n \n .jsx-parser .title {\n padding-top: 0pt;\n color: #000000;\n font-size: 26pt;\n padding-bottom: 3pt;\n font-family: \"Arial\";\n line-height: 1.15;\n page-break-after: avoid;\n orphans: 2;\n widows: 2;\n text-align: left\n }\n \n .jsx-parser .subtitle {\n padding-top: 0pt;\n color: #666666;\n font-size: 15pt;\n padding-bottom: 16pt;\n font-family: \"Arial\";\n line-height: 1.15;\n page-break-after: avoid;\n orphans: 2;\n widows: 2;\n text-align: left\n }\n \n .jsx-parser li {\n color: #000000;\n font-size: 11pt;\n font-family: \"Arial\"\n }\n \n .jsx-parser p {\n margin: 0;\n color: #000000;\n font-size: 11pt;\n font-family: \"Arial\"\n }\n \n .jsx-parser h1 {\n padding-top: 20pt;\n color: #000000;\n font-size: 20pt;\n padding-bottom: 6pt;\n font-family: \"Arial\";\n line-height: 1.15;\n page-break-after: avoid;\n orphans: 2;\n widows: 2;\n text-align: left\n }\n \n .jsx-parser h2 {\n padding-top: 18pt;\n color: #000000;\n font-size: 16pt;\n padding-bottom: 6pt;\n font-family: \"Arial\";\n line-height: 1.15;\n page-break-after: avoid;\n orphans: 2;\n widows: 2;\n text-align: left\n }\n \n .jsx-parser h3 {\n padding-top: 16pt;\n color: #434343;\n font-size: 14pt;\n padding-bottom: 4pt;\n font-family: \"Arial\";\n line-height: 1.15;\n page-break-after: avoid;\n orphans: 2;\n widows: 2;\n text-align: left\n }\n \n .jsx-parser h4 {\n padding-top: 14pt;\n color: #666666;\n font-size: 12pt;\n padding-bottom: 4pt;\n font-family: \"Arial\";\n line-height: 1.15;\n page-break-after: avoid;\n orphans: 2;\n widows: 2;\n text-align: left\n }\n \n .jsx-parser h5 {\n padding-top: 12pt;\n color: #666666;\n font-size: 11pt;\n padding-bottom: 4pt;\n font-family: \"Arial\";\n line-height: 1.15;\n page-break-after: avoid;\n orphans: 2;\n widows: 2;\n text-align: left\n }\n \n .jsx-parser h6 {\n padding-top: 12pt;\n color: #666666;\n font-size: 11pt;\n padding-bottom: 4pt;\n font-family: \"Arial\";\n line-height: 1.15;\n page-break-after: avoid;\n font-style: italic;\n orphans: 2;\n widows: 2;\n text-align: left\n }\n }","jsx":"<div class=\"c8\">\r\n <p class=\"c17 c21\"><span class=\"c10\"></span></p><a id=\"t.596889bd2267afc7ef97a3091f18b552ea14f1a8\"></a><a\r\n id=\"t.0\"></a>\r\n <table class=\"c24\">\r\n <tbody>\r\n <tr class=\"c12\">\r\n <td class=\"c29\" colspan=\"1\" rowspan=\"1\">\r\n <p class=\"c17\"><span class=\"c22\">Đơn vị: Luci Building</span></p>\r\n <p class=\"c17\"><span class=\"c25\">Bộ phận:.........................................</span></p>\r\n </td>\r\n <td class=\"c19\" colspan=\"1\" rowspan=\"1\">\r\n <p class=\"c5\"><span class=\"c22\">Mẫu số: 01-TT</span></p>\r\n <p class=\"c5\"><span class=\"c25\">(Ban hành theo quyết định số: 48/2006/QĐ - BTC Ngày 14/9/2006 của bộ trưởng BTC)</span></p>\r\n </td>\r\n </tr>\r\n </tbody>\r\n </table>\r\n <p class=\"c7\"><span class=\"c7c20\"></span><span class=\"c13\">PHIẾU CHI</span><span class=\"c7c20\">Số: {number}</span></p>\r\n <p class=\"c9 c28\"><span class=\"c2\">{execution_date}</span></p>\r\n <p class=\"c9999 c28\"><span class=\"c2\">{bill_name}</span></p>\r\n <p class=\"c9 c11\"><span class=\"c2\"></span></p><a id=\"t.e573e07dec41c32b04b625135152558b5f9d025b\"></a><a\r\n id=\"t.1\"></a>\r\n <table class=\"c23\">\r\n <tbody>\r\n <tr class=\"c12\">\r\n <td class=\"c14\" colspan=\"1\" rowspan=\"1\">\r\n <p class=\"c0\"><span class=\"c1\">Họ và tên người nhận:</span></p>\r\n </td>\r\n <td class=\"c6\" colspan=\"1\" rowspan=\"1\">\r\n <p class=\"c0\"><span class=\"c1\">{payer_name}</span></p>\r\n </td>\r\n </tr>\r\n <tr class=\"c12\">\r\n <td class=\"c14\" colspan=\"1\" rowspan=\"1\">\r\n <p class=\"c0\"><span class=\"c1\">Căn hộ:</span></p>\r\n </td>\r\n <td class=\"c6\" colspan=\"1\" rowspan=\"1\">\r\n <p class=\"c0\"><span class=\"c1\">{apartment_name}</span></p>\r\n </td>\r\n </tr>\r\n <tr class=\"c12\">\r\n <td class=\"c14\" colspan=\"1\" rowspan=\"1\">\r\n <p class=\"c0\"><span class=\"c1\">Lý do chi:</span></p>\r\n </td>\r\n <td class=\"c6\" colspan=\"1\" rowspan=\"1\">\r\n {fees}\r\n </td>\r\n </tr>\r\n <tr class=\"c12\">\r\n <td class=\"c14\" colspan=\"1\" rowspan=\"1\">\r\n <p class=\"c0\"><span class=\"c1\">Số tiền:</span></p>\r\n </td>\r\n <td class=\"c6\" colspan=\"1\" rowspan=\"1\">\r\n <p class=\"c0\"><span class=\"c20\">{total_new_money_collected} VND</span></p>\r\n </td>\r\n </tr>\r\n <tr class=\"c12\">\r\n <td class=\"c14\" colspan=\"1\" rowspan=\"1\">\r\n <p class=\"c0\"><span class=\"c1\">Viết bằng chữ:</span></p>\r\n </td>\r\n <td class=\"c6\" colspan=\"1\" rowspan=\"1\">\r\n <p class=\"c0\"><span class=\"c20\">{total_new_money_collected_string}</span></p>\r\n </td>\r\n </tr>\r\n <tr class=\"c12\">\r\n <td class=\"c14\" colspan=\"1\" rowspan=\"1\">\r\n <p class=\"c0\"><span class=\"c1\">Kèm theo:.................................</span></p>\r\n </td>\r\n <td class=\"c6\" colspan=\"1\" rowspan=\"1\">\r\n <p class=\"c0\"><span class=\"c1\">Chứng từ gốc.</span></p>\r\n </td>\r\n </tr>\r\n </tbody>\r\n </table>\r\n <p class=\"c17 c21\"><span class=\"c10\"></span></p><a id=\"t.a888a99cd7e3fadfab7e4e8e6ed1ccd37f91d10f\"></a><a\r\n id=\"t.2\"></a>\r\n <table class=\"c18\">\r\n <tbody>\r\n <tr class=\"c4\">\r\n <td class=\"c3\" colspan=\"1\" rowspan=\"1\">\r\n <p class=\"c9\"><span class=\"c2\">Giám đốc</span></p>\r\n <p class=\"c9\"><span class=\"c16\">(Ký, họ tên, đóng dấu)</span>\r\n </p>\r\n </td>\r\n <td class=\"c28 c30\" colspan=\"1\" rowspan=\"1\">\r\n <p class=\"c9\"><span class=\"c2\">Trưởng ban quản lý</span></p>\r\n <p class=\"c9\"><span class=\"c16\">(Ký, họ tên)</span></p>\r\n </td>\r\n <td class=\"c15\" colspan=\"1\" rowspan=\"1\">\r\n <p class=\"c9\"><span class=\"c2\">Kế toán</span></p>\r\n <p class=\"c9\"><span class=\"c16\">(Ký, họ tên)</span></p>\r\n </td>\r\n <td class=\"c27\" colspan=\"1\" rowspan=\"1\">\r\n <p class=\"c9\"><span class=\"c2\">Người nhận tiền</span></p>\r\n <p class=\"c9\"><span class=\"c16\">(Ký, họ tên)</span></p>\r\n </td>\r\n <td class=\"c26\" colspan=\"1\" rowspan=\"1\">\r\n <p class=\"c9\"><span class=\"c2\">Người lập phiếu</span></p>\r\n <p class=\"c9\"><span class=\"c16\">(Ký, họ tên)</span></p>\r\n </td>\r\n </tr>\r\n </tbody>\r\n </table>\r\n <p class=\"c17 c21\"><span class=\"c10\"></span></p>\r\n</div>","jsx_row":"\n <p class=\"c0\"><span class=\"c1\">Thu {rr.service_map_management_service_name} {rr.fee_of_month}: {rr.new_money_collected} &#273;&#7891;ng</span></p>\n "}';
            if(!$buildingCluster->save()){
                Yii::error($buildingCluster->errors);
            }
        }
    }

    /**
     * {@inheritdoc}
     */
    public function safeDown()
    {
        echo "m200824_034801_add_collumn_logic_phieu_chi cannot be reverted.\n";

        return false;
    }

    /*
    // Use up()/down() to run migration code without a transaction.
    public function up()
    {

    }

    public function down()
    {
        echo "m200824_034801_add_collumn_logic_phieu_chi cannot be reverted.\n";

        return false;
    }
    */
}
